version: 2.1
jobs:
  deploy:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout

      - run:
          name: Install rsync (if missing)
          command: |
            sudo apt-get update -y
            sudo apt-get install -y rsync

      - run:
          name: Prepare SSH key
          command: |
            mkdir -p ~/.ssh
            echo -e "Host *\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config

      - run:
          name: Copy K8s manifests to EC2
          command: |
            rsync -avz k8s/ ${EC2_USER}@${EC2_HOST}:/home/${EC2_USER}/k8s/

      - run:
          name: Deploy on EC2 via SSH
          command: |
            ssh ${EC2_USER}@${EC2_HOST} 'bash -s' <<'EOF'
            set -euo pipefail

            # Ensure AWS CLI is present
            if ! command -v aws >/dev/null 2>&1; then
              sudo yum install -y awscli
            fi

            # Vars from CircleCI env
            NAMESPACE=default
            SECRET_NAME=regcred
            docker_server="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
            IMAGE_TAG="${CIRCLE_SHA1}"

            # 1) Refresh ECR pull secret using EC2 IAM role
            token=$(aws ecr get-login-password --region "${AWS_REGION}")
            kubectl -n "${NAMESPACE}" delete secret "${SECRET_NAME}" --ignore-not-found
            kubectl -n "${NAMESPACE}" create secret docker-registry "${
