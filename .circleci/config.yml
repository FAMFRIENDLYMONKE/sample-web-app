version: 2.1

jobs:
  deploy:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout

      # Load private SSH key added in CircleCI settings
      - add_ssh_keys:
          fingerprints:
            - "AA:BB:CC:DD:EE:FF:11:22:33:44:55:66:77:88:99:00"   # <-- CHANGE to your SSH key fingerprint

      - run:
          name: Deploy on EC2 via SSH (passing all env vars)
          command: |
            ssh -tt -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} \
            "AWS_ACCOUNT_ID='${AWS_ACCOUNT_ID}' \
            AWS_REGION='${AWS_REGION}' \
            ECR_REPO='${ECR_REPO}' \
            IMAGE_TAG='${IMAGE_TAG:-${CIRCLE_SHA1}}' \
            EC2_USER='${EC2_USER}' \
            bash -s" \<< 'EOF'
            set -euo pipefail

            docker_server="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

            echo "Using image: $docker_server/$ECR_REPO:$IMAGE_TAG"

            # (then the rest of your commands...)
            sed -i \
              "s#<AWS_ACCOUNT_ID>.dkr.ecr.<AWS_REGION>.amazonaws.com/<ECR_REPO>:<IMAGE_TAG>#${docker_server}/${ECR_REPO}:${IMAGE_TAG}#g" \
              /home/${EC2_USER}/k8s/deployment.yaml

            kubectl apply -f /home/${EC2_USER}/k8s/deployment.yaml
            kubectl apply -f ~/k8s/service.yaml || true
            kubectl wait --for=condition=available --timeout=600s deployment/webapp
            EOF 

workflows:
  deploy_on_main:
    jobs:
      - deploy:
          filters:
            branches:
              only: main